<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard — Damayanti</title>
<style>
:root{
  --bg:#eef3ff; --card:#fff; --ink:#111827; --muted:#6b7280;
  --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  --ring:rgba(37,99,235,.25); --radius:16px
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(#f7fbff,#e9f0ff);font:14px/1.5 system-ui}
header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:rgba(255,255,255,.7);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
h1{margin:0;font-size:18px}
.wrap{max-width:1180px;margin:18px auto;padding:0 16px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.05);border:1px solid #e5e7eb;padding:16px}
.grid{display:grid;gap:16px}.g2{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(3,1fr)}
@media(max-width:960px){.g2,.g3{grid-template-columns:1fr}}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:10px 12px;border-bottom:1px solid #eef2f7;vertical-align:top}
th{background:#f9fafb;font-weight:600;text-align:left}
tr:hover td{background:#fafcff}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,textarea{width:100%;min-height:38px;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;outline:none}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring);border-color:var(--brand)}
button{height:38px;padding:0 12px;border:1px solid #d1d5db;background:#fff;border-radius:10px;cursor:pointer}
.btn{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ok{background:var(--ok);border-color:var(--ok)}
.btn.warn{background:var(--warn);border-color:var(--warn)}
.btn.bad{background:var(--bad);border-color:var(--bad)}
.muted{color:var(--muted)} .right{margin-left:auto}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb}
.hidden{display:none!important}
.note{font-size:12px;color:#6b7280} .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
.hr{height:1px;background:#eef2f7;margin:10px 0}
</style>
</head>
<body>
<header>
  <h1>Admin Dashboard — Damayanti</h1>
  <div class="toolbar">
    <span id="authInfo" class="muted">Belum login</span>
    <button id="btnLogout" class="hidden">Keluar</button>
  </div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <section id="loginSection" class="card" style="max-width:420px;margin:40px auto">
    <h3 style="margin:0 0 8px 0;">Masuk Admin</h3>
    <div class="note">Endpoint: <code>POST /api/auth/login</code></div>
    <div class="grid g2 mt12">
      <div><label class="muted">Email</label><input id="loginEmail" type="email" placeholder="admin@email.com"></div>
      <div><label class="muted">Password</label><input id="loginPass" type="password" placeholder="••••••••"></div>
    </div>
    <div class="toolbar mt12">
      <button id="btnLogin" class="btn">Masuk</button>
      <span id="loginMsg" class="muted"></span>
    </div>
    <div class="hr"></div>
    <div class="note">Tanpa login Anda tetap bisa <b>GET</b> data. Aksi <b>Tambah/Ubah/Hapus</b> membutuhkan token admin.</div>
  </section>

  <!-- MAIN -->
  <section id="mainSection" class="hidden">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="summary">Ringkasan</div>
      <div class="tab" data-tab="containers">Containers</div>
      <div class="tab" data-tab="students">Students</div>
      <div class="tab" data-tab="sheeps">Sheeps</div>
      <div class="tab" data-tab="sensor">Sensor Data</div>
      <div class="tab" data-tab="reports">Reports</div>
      <div class="tab" data-tab="sheepReports">Sheep Reports</div>
    </div>

    <!-- SUMMARY -->
    <div id="tab-summary" class="mt16">
      <div class="grid g3">
        <div class="card"><div class="muted">Total Containers</div><div id="sumContainers" style="font-weight:700;font-size:28px">—</div></div>
        <div class="card"><div class="muted">Total Students</div><div id="sumStudents" style="font-weight:700;font-size:28px">—</div></div>
        <div class="card"><div class="muted">Total Sheeps</div><div id="sumSheeps" style="font-weight:700;font-size:28px">—</div></div>
        <div class="card"><div class="muted">Total Sensor Records</div><div id="sumSensor" style="font-weight:700;font-size:28px">—</div></div>
        <div class="card"><div class="muted">Total Reports</div><div id="sumReports" style="font-weight:700;font-size:28px">—</div></div>
        <div class="card"><div class="muted">Total Sheep Reports</div><div id="sumSheepReports" style="font-weight:700;font-size:28px">—</div></div>
      </div>
    </div>

    <!-- CONTAINERS -->
    <div id="tab-containers" class="mt16 hidden">
      <div class="card">
        <div class="toolbar">
          <strong>Containers</strong>
          <span class="badge">Admin only tambah/ubah/hapus</span>
          <input id="searchContainers" placeholder="Cari nama/kode..." style="max-width:260px" class="right">
          <button id="btnNewContainer" class="btn">Tambah</button>
        </div>
        <div class="mt12" style="overflow:auto">
          <table id="tblContainers">
            <thead><tr><th>ID</th><th>Nama/Kode</th><th>Lokasi</th><th>Dibuat</th><th style="width:160px">Aksi</th></tr></thead>
            <tbody><tr><td colspan="5" class="muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- STUDENTS -->
    <div id="tab-students" class="mt16 hidden">
      <div class="card">
        <div class="toolbar">
          <strong>Students</strong>
          <span class="badge">Admin only tambah/ubah/hapus</span>
          <input id="searchStudents" placeholder="Cari nama…" style="max-width:260px" class="right">
          <button id="btnNewStudent" class="btn">Tambah</button>
        </div>
        <div class="mt12" style="overflow:auto">
          <table id="tblStudents">
            <thead><tr><th>ID</th><th>Nama</th><th>Dibuat</th><th style="width:160px">Aksi</th></tr></thead>
            <tbody><tr><td colspan="4" class="muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SHEEPS -->
    <div id="tab-sheeps" class="mt16 hidden">
      <div class="card">
        <div class="toolbar">
          <strong>Sheeps</strong>
          <span class="badge">Admin only tambah/ubah/hapus</span>
          <input id="searchSheeps" placeholder="Cari nama kambing…" style="max-width:260px" class="right">
          <button id="btnNewSheep" class="btn">Tambah</button>
        </div>
        <div class="mt12" style="overflow:auto">
          <table id="tblSheeps">
            <thead><tr><th>ID</th><th>Nama</th><th>Umur</th><th>Dibuat</th><th style="width:160px">Aksi</th></tr></thead>
            <tbody><tr><td colspan="5" class="muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SENSOR DATA -->
    <div id="tab-sensor" class="mt16 hidden">
      <div class="card">
        <div class="toolbar">
          <strong>Sensor Data</strong>
          <select id="filterSensorContainer" style="max-width:260px" class="right"></select>
          <button id="btnNewSensor" class="btn">Tambah</button>
        </div>
        <div class="mt12" style="overflow:auto">
          <table id="tblSensor">
            <thead>
              <tr><th>ID</th><th>Container</th><th>Recorded</th><th>T</th><th>H</th><th>G</th><th>pH</th><th>Status</th><th style="width:160px">Aksi</th></tr>
            </thead>
            <tbody><tr><td colspan="9" class="muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- REPORTS -->
    <div id="tab-reports" class="mt16 hidden">
      <div class="card">
        <div class="toolbar">
          <strong>Reports</strong>
          <select id="filterReportContainer" style="max-width:260px" class="right"></select>
          <button id="btnNewReport" class="btn">Tambah</button>
        </div>
        <div class="mt12" style="overflow:auto">
          <table id="tblReports">
            <thead><tr><th>ID</th><th>Container</th><th>Tanggal</th><th>Catatan</th><th style="width:140px">Aksi</th></tr></thead>
            <tbody><tr><td colspan="5" class="muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SHEEP REPORTS -->
    <div id="tab-sheepReports" class="mt16 hidden">
      <div class="card">
        <div class="toolbar">
          <strong>Sheep Reports</strong>
          <select id="filterSheep" style="max-width:260px" class="right"></select>
          <button id="btnNewSheepReport" class="btn">Tambah</button>
        </div>
        <div class="mt12" style="overflow:auto">
          <table id="tblSheepReports">
            <thead><tr><th>ID</th><th>Sheep</th><th>Waktu</th><th>Status</th><th style="width:160px">Aksi</th></tr></thead>
            <tbody><tr><td colspan="5" class="muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- MODAL -->
<div id="modal" class="hidden" style="position:fixed;inset:0;background:rgba(17,24,39,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50">
  <div class="card" style="width:min(720px,100%);max-height:90vh;overflow:auto">
    <div class="toolbar"><strong id="modalTitle">Modal</strong><button id="modalClose" class="right">Tutup</button></div>
    <div id="modalBody" class="mt12"></div>
  </div>
</div>

<script>
/* ====== CONFIG + HELPERS ====== */
const API_BASE = "https://damayanti-api.vercel.app";
let ADMIN_TOKEN = localStorage.getItem("damayanti_token") || null;

const qs  = (s, r=document)=>r.querySelector(s);
const qsa = (s, r=document)=>[...r.querySelectorAll(s)];

function authHeaders(h={}){ return ADMIN_TOKEN ? { ...h, Authorization: "Bearer " + ADMIN_TOKEN } : h; }
async function api(path, opts={}) {
  const headers = authHeaders({ "Content-Type":"application/json", ...(opts.headers||{}) });
  const res = await fetch(API_BASE + path, { ...opts, headers });

  if (!res.ok) {
    // pesan error yang jelas (tanpa pop-up spam)
    let msg = `${res.status} ${res.statusText}`;
    try {
      const j = await res.json();
      msg += `: ${j.message || j.error || JSON.stringify(j)}`;
    } catch {
      const t = await res.text().catch(()=> "");
      if (t) msg += `: ${t}`;
    }
    throw new Error(msg);
  }
  return res.status===204 ? null : res.json();
}
function unwrapList(p){ if(Array.isArray(p)) return p; if(p && Array.isArray(p.data)) return p.data; return []; }
function fmtDate(x){ try{return new Date(x).toLocaleString()}catch{return x||"-"} }
function mustAdmin(){ if(!ADMIN_TOKEN){ alert("Aksi ini membutuhkan login admin. Silakan login dulu."); return false; } return true; }
function showErr(e){ alert(e?.message || "Terjadi kesalahan"); }

/* ====== AUTH ====== */
const loginSection = qs("#loginSection"), mainSection = qs("#mainSection");
const authInfo = qs("#authInfo"), btnLogout = qs("#btnLogout");
function syncAuthUI(){
  if(ADMIN_TOKEN){ authInfo.textContent="Logged in"; btnLogout.classList.remove("hidden"); loginSection.classList.add("hidden"); mainSection.classList.remove("hidden"); }
  else{ authInfo.textContent="Belum login"; btnLogout.classList.add("hidden"); loginSection.classList.remove("hidden"); mainSection.classList.add("hidden"); }
}
qs("#btnLogin").onclick = async ()=>{
  const email=qs("#loginEmail").value.trim(), password=qs("#loginPass").value;
  qs("#loginMsg").textContent="Memproses…";
  try{
    const data = await fetch(API_BASE+"/api/auth/login",{
      method:"POST",headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({email,password})
    }).then(r=>r.json());
    ADMIN_TOKEN = data?.token || data?.access_token; 
    if(!ADMIN_TOKEN) throw new Error("Token tidak ditemukan di respons.");
    localStorage.setItem("damayanti_token", ADMIN_TOKEN);
    qs("#loginMsg").textContent="Berhasil masuk.";
    syncAuthUI(); boot();
  }catch(e){ qs("#loginMsg").textContent="Gagal login: "+e.message; }
};
btnLogout.onclick = ()=>{ ADMIN_TOKEN=null; localStorage.removeItem("damayanti_token"); syncAuthUI(); };

/* ====== TABS ====== */
const tabs = qs("#tabs");
tabs.onclick = (e)=>{
  const t=e.target.closest(".tab"); if(!t) return;
  qsa(".tab").forEach(x=>x.classList.remove("active")); t.classList.add("active");
  qsa('[id^="tab-"]').forEach(x=>x.classList.add("hidden")); qs("#tab-"+t.dataset.tab).classList.remove("hidden");
  if(t.dataset.tab==="summary") loadSummary();
  if(t.dataset.tab==="containers") loadContainers();
  if(t.dataset.tab==="students")   loadStudents();
  if(t.dataset.tab==="sheeps")     loadSheeps();
  if(t.dataset.tab==="sensor")     loadSensor();
  if(t.dataset.tab==="reports")    loadReports();
  if(t.dataset.tab==="sheepReports") loadSheepReports();
};

/* ====== MODAL ====== */
const modal = qs("#modal"), modalBody = qs("#modalBody"), modalTitle = qs("#modalTitle");
qs("#modalClose").onclick = ()=>modal.classList.add("hidden");
function openModal(title, html){ modalTitle.textContent=title; modalBody.innerHTML=html; modal.classList.remove("hidden"); }

/* ====== SUMMARY ====== */
async function loadSummary(){
  try{
    const [containers, students, sheeps, sensor, reports, sReports] = await Promise.all([
      api("/api/containers?limit=1000").catch(()=>({data:[]})),
      api("/api/students?limit=1000").catch(()=>({data:[]})),
      api("/api/sheeps?limit=1000").catch(()=>({data:[]})),
      api("/api/sensor-data?limit=1000").catch(()=>({data:[]})),
      api("/api/reports?limit=1000").catch(()=>({data:[]})),
      api("/api/sheep-reports?limit=1000").catch(()=>({data:[]})),
    ]);
    qs("#sumContainers").textContent = unwrapList(containers).length;
    qs("#sumStudents").textContent  = unwrapList(students).length;
    qs("#sumSheeps").textContent    = unwrapList(sheeps).length;
    qs("#sumSensor").textContent    = unwrapList(sensor).length;
    qs("#sumReports").textContent   = unwrapList(reports).length;
    qs("#sumSheepReports").textContent = unwrapList(sReports).length;
  }catch(e){ console.error(e); }
}

/* ====== CONTAINERS (CRUD) ====== */
let cacheContainers=[];
async function loadContainers(){
  const tb = qs("#tblContainers tbody");
  try{
    cacheContainers = unwrapList(await api("/api/containers?limit=500"));
    renderContainerTable(cacheContainers);
    qs("#searchContainers").oninput = (e)=>{
      const q = e.target.value.toLowerCase();
      renderContainerTable(cacheContainers.filter(c=>((c.name||c.code||"")+(c.location||"")).toLowerCase().includes(q)));
    };
    qs("#btnNewContainer").onclick = ()=>{ if(!mustAdmin()) return; showContainerForm(); };
  }catch(e){
    tb.innerHTML = `<tr><td colspan="5" class="muted">
      Gagal memuat containers: ${e.message}.
      ${/user_id does not exist/i.test(e.message) ? "Ini bug di backend (kolom user_id tidak ada)." : ""}
    </td></tr>`;
  }
}
function renderContainerTable(list){
  const tb = qs("#tblContainers tbody");
  tb.innerHTML = list.length ? list.map(c=>`
    <tr>
      <td class="muted">${c.id}</td>
      <td>${c.name||c.code||"-"}</td>
      <td>${c.location||"-"}</td>
      <td class="muted">${fmtDate(c.created_at)}</td>
      <td>
        <button class="btn warn" data-ed="${c.id}" ${!ADMIN_TOKEN?'disabled':''}>Ubah</button>
        <button class="btn bad" data-del="${c.id}" ${!ADMIN_TOKEN?'disabled':''}>Hapus</button>
      </td>
    </tr>`).join("") : `<tr><td colspan="5" class="muted">Tidak ada data.</td></tr>`;
  tb.onclick = async (e)=>{
    const ed=e.target.closest("[data-ed]"), del=e.target.closest("[data-del]");
    if(ed){ if(!mustAdmin()) return; const item=cacheContainers.find(x=>x.id===ed.dataset.ed); showContainerForm(item); }
    if(del){ if(!mustAdmin()) return; if(!confirm("Hapus container ini?")) return;
      try{ await api("/api/containers/"+del.dataset.del,{method:"DELETE"}); loadContainers(); }catch(err){ showErr(err); }
    }
  };
}
function showContainerForm(item){
  openModal(item?"Ubah Container":"Tambah Container", `
    <div class="grid g2">
      <div><label class="muted">Kode (wajib)</label><input id="fCode" value="${item?.code||item?.name||""}"></div>
      <div><label class="muted">Nama (opsional)</label><input id="fName" value="${item?.name||""}"></div>
      <div><label class="muted">Lokasi</label><input id="fLoc" value="${item?.location||""}"></div>
    </div>
    <div class="toolbar mt16"><button id="save" class="btn">${item?"Simpan":"Buat"}</button></div>
    <div class="note">Endpoint: ${item? "PUT /api/containers/{id}" : "POST /api/containers"} — field utama: <b>code</b>, <i>location</i>, (opsional <i>name</i>)</div>
  `);
  qs("#save").onclick = async ()=>{
    if(!mustAdmin()) return;
    const payload = { code: qs("#fCode").value.trim(), location: qs("#fLoc").value.trim() };
    const nm = qs("#fName").value.trim(); if(nm) payload.name = nm;
    if(!payload.code){ alert("Kode wajib diisi."); return; }
    try{
      const opts = { method: item?"PUT":"POST", body: JSON.stringify(payload) };
      if(item) await api("/api/containers/"+item.id, opts); else await api("/api/containers", opts);
      modal.classList.add("hidden"); loadContainers();
    }catch(e){ showErr(e); }
  };
}

/* ====== STUDENTS (CRUD) ====== */
let cacheStudents=[];
async function loadStudents(){
  try{
    const res = await api("/api/students?limit=500").catch(()=>({data:[]}));
    cacheStudents = Array.isArray(res) ? res : (res.data || []);
    renderStudentTable(cacheStudents);
    qs("#searchStudents").oninput = (e)=>{
      const q=e.target.value.toLowerCase();
      renderStudentTable(cacheStudents.filter(s=>(s.full_name||s.name||"").toLowerCase().includes(q)));
    };
    qs("#btnNewStudent").onclick = ()=>{ if(!mustAdmin()) return; showStudentForm(); };
  }catch(e){
    const tb = qs("#tblStudents tbody");
    tb.innerHTML = `<tr><td colspan="4" class="muted">Gagal memuat students: ${e.message}</td></tr>`;
  }
}
function renderStudentTable(list){
  const tb = qs("#tblStudents tbody");
  tb.innerHTML = list.length ? list.map(s=>`
    <tr>
      <td class="muted">${s.id}</td>
      <td>${s.full_name||s.name||"-"}</td>
      <td class="muted">${fmtDate(s.created_at)}</td>
      <td>
        <button class="btn warn" data-ed="${s.id}" ${!ADMIN_TOKEN?'disabled':''}>Ubah</button>
        <button class="btn bad" data-del="${s.id}" ${!ADMIN_TOKEN?'disabled':''}>Hapus</button>
      </td>
    </tr>`).join("") : `<tr><td colspan="4" class="muted">Tidak ada data.</td></tr>`;
  tb.onclick = async (e)=>{
    const ed=e.target.closest("[data-ed]"), del=e.target.closest("[data-del]");
    if(ed){ if(!mustAdmin()) return; const it=cacheStudents.find(x=>x.id===ed.dataset.ed); showStudentForm(it); }
    if(del){ if(!mustAdmin()) return; if(!confirm("Hapus student ini?")) return;
      try{ await api("/api/students/"+del.dataset.del,{method:"DELETE"}); loadStudents(); }catch(err){ showErr(err); }
    }
  };
}
function showStudentForm(item){
  openModal(item?"Ubah Student":"Tambah Student", `
    <div><label class="muted">Nama Lengkap</label><input id="sName" value="${item?.full_name||item?.name||""}"></div>
    <div class="toolbar mt16"><button id="saveS" class="btn">${item?"Simpan":"Buat"}</button></div>
    <div class="note">Endpoint: ${item? "PUT /api/students/{id}" : "POST /api/students"} — field: <b>name</b>/<b>full_name</b></div>
  `);
  qs("#saveS").onclick = async ()=>{
    if(!mustAdmin()) return;
    const nm = qs("#sName").value.trim();
    if(!nm){ alert("Nama wajib diisi."); return; }
    // kirim dua-duanya agar kompatibel
    const payload = { name: nm, full_name: nm };
    try{
      const opts = { method: item?"PUT":"POST", body: JSON.stringify(payload) };
      if(item) await api("/api/students/"+item.id, opts); else await api("/api/students", opts);
      modal.classList.add("hidden"); loadStudents();
    }catch(e){ showErr(e); }
  };
}

/* ====== SHEEPS (CRUD) ====== */
let cacheSheeps=[];
async function loadSheeps(){
  try{
    cacheSheeps = unwrapList(await api("/api/sheeps?limit=500"));
    renderSheeps(cacheSheeps);
    qs("#searchSheeps").oninput = (e)=>{
      const q=e.target.value.toLowerCase();
      renderSheeps(cacheSheeps.filter(s=>(s.name||"").toLowerCase().includes(q)));
    };
    qs("#btnNewSheep").onclick = ()=>{ if(!mustAdmin()) return; showSheepForm(); };
  }catch(e){
    const tb = qs("#tblSheeps tbody");
    tb.innerHTML = `<tr><td colspan="5" class="muted">Gagal memuat sheeps: ${e.message}</td></tr>`;
  }
}
function renderSheeps(list){
  const tb = qs("#tblSheeps tbody");
  tb.innerHTML = list.length ? list.map(s=>`
    <tr>
      <td class="muted">${s.id}</td>
      <td>${s.name||"-"}</td>
      <td>${s.age ?? "-"}</td>
      <td class="muted">${fmtDate(s.created_at)}</td>
      <td>
        <button class="btn warn" data-ed="${s.id}" ${!ADMIN_TOKEN?'disabled':''}>Ubah</button>
        <button class="btn bad" data-del="${s.id}" ${!ADMIN_TOKEN?'disabled':''}>Hapus</button>
      </td>
    </tr>`).join("") : `<tr><td colspan="5" class="muted">Tidak ada data.</td></tr>`;
  tb.onclick = async (e)=>{
    const ed=e.target.closest("[data-ed]"), del=e.target.closest("[data-del]");
    if(ed){ if(!mustAdmin()) return; const it=cacheSheeps.find(x=>x.id===ed.dataset.ed); showSheepForm(it); }
    if(del){ if(!mustAdmin()) return; if(!confirm("Hapus sheep ini?")) return;
      try{ await api("/api/sheeps/"+del.dataset.del,{method:"DELETE"}); loadSheeps(); }catch(err){ showErr(err); }
    }
  };
}
function showSheepForm(item){
  openModal(item?"Ubah Sheep":"Tambah Sheep", `
    <div class="grid g2">
      <div><label class="muted">Nama</label><input id="shName" value="${item?.name||""}"></div>
      <div><label class="muted">Umur (tahun)</label><input id="shAge" type="number" step="1" value="${item?.age ?? ""}"></div>
    </div>
    <div class="toolbar mt16"><button id="saveSh" class="btn">${item?"Simpan":"Buat"}</button></div>
    <div class="note">Endpoint: ${item? "PUT /api/sheeps/{id}" : "POST /api/sheeps"}</div>
  `);
  qs("#saveSh").onclick = async ()=>{
    if(!mustAdmin()) return;
    const payload = { name: qs("#shName").value.trim(), age: Number(qs("#shAge").value||0) };
    if(!payload.name){ alert("Nama wajib diisi."); return; }
    try{
      const opts = { method: item?"PUT":"POST", body: JSON.stringify(payload) };
      if(item) await api("/api/sheeps/"+item.id, opts); else await api("/api/sheeps", opts);
      modal.classList.add("hidden"); loadSheeps();
    }catch(e){ showErr(e); }
  };
}

/* ====== SENSOR DATA ====== */
let cacheSensor=[], containersMini=[];
async function loadSensor(){
  const tb = qs("#tblSensor tbody");
  try{
    containersMini = unwrapList(await api("/api/containers?limit=500"));
    const sel=qs("#filterSensorContainer");
    sel.innerHTML = `<option value="">Semua container</option>`+containersMini.map(c=>`<option value="${c.id}">${c.name||c.code||c.id}</option>`).join("");

    cacheSensor = unwrapList(await api("/api/sensor-data?limit=500"));
    renderSensorTable(); sel.onchange=renderSensorTable;
    qs("#btnNewSensor").onclick = ()=>showSensorForm();
  }catch(e){
    tb.innerHTML = `<tr><td colspan="9" class="muted">
      Gagal memuat sensor data: ${e.message}.
      ${/user_id does not exist/i.test(e.message) ? "Ini bug di backend (kolom user_id tidak ada)." : ""}
    </td></tr>`;
  }
}
function renderSensorTable(){
  const cid=qs("#filterSensorContainer").value;
  const list=cacheSensor.filter(x=>!cid || x.container_id===cid);
  const tb=qs("#tblSensor tbody");
  tb.innerHTML = list.length ? list.map(r=>{
    const cName=(containersMini.find(c=>c.id===r.container_id)?.name)||r.container_id||"-";
    return `<tr>
      <td class="muted">${r.id}</td><td>${cName}</td><td class="muted">${fmtDate(r.recorded_at||r.created_at)}</td>
      <td>${r.temperature ?? "-"}</td><td>${r.humidity ?? "-"}</td><td>${r.gas ?? "-"}</td><td>${r.ph ?? "-"}</td>
      <td>${r.status ?? "-"}</td>
      <td><button class="btn warn" data-ed="${r.id}">Ubah</button> <button class="btn bad" data-del="${r.id}">Hapus</button></td>
    </tr>`;
  }).join("") : `<tr><td colspan="9" class="muted">Tidak ada data.</td></tr>`;
  tb.onclick = async (e)=>{
    const ed=e.target.closest("[data-ed]"), del=e.target.closest("[data-del]");
    if(ed){ const it=cacheSensor.find(x=>x.id===ed.dataset.ed); showSensorForm(it); }
    if(del){ if(!confirm("Hapus record ini?")) return;
      try{ await api("/api/sensor-data/"+del.dataset.del,{method:"DELETE"}); loadSensor(); }catch(err){ showErr(err); }
    }
  };
}
function showSensorForm(item){
  openModal(item?"Ubah Sensor Data":"Tambah Sensor Data", `
    <div class="grid g2">
      <div><label class="muted">Container</label><select id="sdC">${containersMini.map(c=>`<option value="${c.id}" ${item?.container_id===c.id?"selected":""}>${c.name||c.code||c.id}</option>`).join("")}</select></div>
      <div><label class="muted">Waktu (ISO)</label><input id="sdTime" value="${item?.recorded_at || new Date().toISOString()}"></div>
      <div><label class="muted">Suhu (°C)</label><input id="sdT" type="number" step="0.1" value="${item?.temperature ?? ""}"></div>
      <div><label class="muted">Kelembapan (%)</label><input id="sdH" type="number" step="0.1" value="${item?.humidity ?? ""}"></div>
      <div><label class="muted">Gas (ppm)</label><input id="sdG" type="number" step="0.1" value="${item?.gas ?? ""}"></div>
      <div><label class="muted">pH</label><input id="sdP" type="number" step="0.1" value="${item?.ph ?? ""}"></div>
      <div><label class="muted">Status</label><select id="sdS">${["Merah","Kuning","Hijau"].map(s=>`<option ${item?.status===s?"selected":""}>${s}</option>`).join("")}</select></div>
    </div>
    <div class="toolbar mt16"><button id="sdSave" class="btn">${item?"Simpan":"Buat"}</button></div>
  `);
  qs("#sdSave").onclick = async ()=>{
    const payload = {
      container_id: qs("#sdC").value, recorded_at: qs("#sdTime").value,
      temperature:+qs("#sdT").value, humidity:+qs("#sdH").value, gas:+qs("#sdG").value, ph:+qs("#sdP").value,
      status: qs("#sdS").value
    };
    try{
      const opts={method:item?"PUT":"POST", body:JSON.stringify(payload)};
      if(item) await api("/api/sensor-data/"+item.id, opts); else await api("/api/sensor-data", opts);
      modal.classList.add("hidden"); loadSensor();
    }catch(e){ showErr(e); }
  };
}

/* ====== REPORTS ====== */
let cacheReports=[];
async function loadReports(){
  const tb = qs("#tblReports tbody");
  try{
    containersMini = unwrapList(await api("/api/containers?limit=500"));
    qs("#filterReportContainer").innerHTML = `<option value="">Semua container</option>`+
      containersMini.map(c=>`<option value="${c.id}">${c.name||c.code||c.id}</option>`).join("");

    cacheReports = unwrapList(await api("/api/reports?limit=500"));
    renderReportsTable();
    qs("#filterReportContainer").onchange = renderReportsTable;
    qs("#btnNewReport").onclick = ()=>showReportForm();
  }catch(e){
    tb.innerHTML = `<tr><td colspan="5" class="muted">
      Gagal memuat reports: ${e.message}.
      ${/user_id does not exist/i.test(e.message) ? "Ini bug di backend (kolom user_id tidak ada)." : ""}
    </td></tr>`;
  }
}
function renderReportsTable(){
  const cid = qs("#filterReportContainer").value;
  const list = cacheReports.filter(r=>!cid || r.container_id===cid);
  const tb = qs("#tblReports tbody");
  tb.innerHTML = list.length ? list.map(r=>{
    const nm = (containersMini.find(c=>c.id===r.container_id)?.name) || r.container_id || "-";
    return `<tr>
      <td class="muted">${r.id}</td><td>${nm}</td><td class="muted">${fmtDate(r.report_date||r.created_at)}</td>
      <td>${r.notes?String(r.notes).replace(/</g,"&lt;"):"-"}</td>
      <td><button class="btn bad" data-del="${r.id}">Hapus</button></td>
    </tr>`;
  }).join("") : `<tr><td colspan="5" class="muted">Tidak ada data.</td></tr>`;
  tb.onclick = async (e)=>{
    const del=e.target.closest("[data-del]"); if(!del) return;
    if(!confirm("Hapus report ini?")) return;
    try{ await api("/api/reports/"+del.dataset.del,{method:"DELETE"}); loadReports(); }catch(err){ showErr(err); }
  };
}
function showReportForm(){
  openModal("Tambah Report", `
    <div class="grid g2">
      <div><label class="muted">Container</label><select id="rpC">${containersMini.map(c=>`<option value="${c.id}">${c.name||c.code||c.id}</option>`).join("")}</select></div>
      <div><label class="muted">Tanggal (ISO)</label><input id="rpD" value="${new Date().toISOString()}"></div>
    </div>
    <div class="mt12"><label class="muted">Catatan</label><textarea id="rpN" rows="4" placeholder="Ringkasan…"></textarea></div>
    <div class="toolbar mt16"><button id="rpSave" class="btn">Buat</button></div>
  `);
  qs("#rpSave").onclick = async ()=>{
    const payload = { container_id: qs("#rpC").value, report_date: qs("#rpD").value, notes: qs("#rpN").value };
    try{ await api("/api/reports",{method:"POST", body:JSON.stringify(payload)}); modal.classList.add("hidden"); loadReports(); }catch(e){ showErr(e); }
  };
}

/* ====== SHEEP REPORTS ====== */
let cacheSheepReports=[];
async function loadSheepReports(){
  try{
    cacheSheeps = unwrapList(await api("/api/sheeps?limit=1000"));
    qs("#filterSheep").innerHTML = `<option value="">Semua kambing</option>`+cacheSheeps.map(s=>`<option value="${s.id}">${s.name||s.id}</option>`).join("");
    cacheSheepReports = unwrapList(await api("/api/sheep-reports?limit=1000"));
    renderSheepReportsTable();
    qs("#filterSheep").onchange = renderSheepReportsTable;
    qs("#btnNewSheepReport").onclick = ()=>showSheepReportForm();
  }catch(e){
    const tb = qs("#tblSheepReports tbody");
    tb.innerHTML = `<tr><td colspan="5" class="muted">Gagal memuat sheep reports: ${e.message}</td></tr>`;
  }
}
function renderSheepReportsTable(){
  const sid = qs("#filterSheep").value;
  const list = cacheSheepReports.filter(r=>!sid || r.sheep_id===sid);
  const tb = qs("#tblSheepReports tbody");
  tb.innerHTML = list.length ? list.map(r=>{
    const nm = (cacheSheeps.find(s=>s.id===r.sheep_id)?.name) || r.sheep_id || "-";
    return `<tr>
      <td class="muted">${r.id}</td><td>${nm}</td><td class="muted">${fmtDate(r.feeding_time||r.created_at)}</td>
      <td>${r.status||"-"}</td>
      <td><button class="btn warn" data-ed="${r.id}">Ubah</button> <button class="btn bad" data-del="${r.id}">Hapus</button></td>
    </tr>`;
  }).join("") : `<tr><td colspan="5" class="muted">Tidak ada data.</td></tr>`;
  tb.onclick = (e)=>{
    const ed=e.target.closest("[data-ed]"), del=e.target.closest("[data-del]");
    if(ed){ const it=cacheSheepReports.find(x=>x.id===ed.dataset.ed); showSheepReportForm(it); }
    if(del){ if(!confirm("Hapus record ini?")) return;
      api("/api/sheep-reports/"+del.dataset.del,{method:"DELETE"}).then(loadSheepReports).catch(showErr);
    }
  };
}
function showSheepReportForm(item){
  openModal(item?"Ubah Sheep Report":"Tambah Sheep Report", `
    <div class="grid g2">
      <div><label class="muted">Sheep</label><select id="srS">${cacheSheeps.map(s=>`<option value="${s.id}" ${item?.sheep_id===s.id?"selected":""}>${s.name||s.id}</option>`).join("")}</select></div>
      <div><label class="muted">Waktu (ISO)</label><input id="srT" value="${item?.feeding_time||new Date().toISOString()}"></div>
      <div><label class="muted">Status</label><select id="srStatus">${["Sudah Diberi Makan","Belum Diberi Makan"].map(x=>`<option ${item?.status===x?"selected":""}>${x}</option>`).join("")}</select></div>
    </div>
    <div class="toolbar mt16"><button id="srSave" class="btn">${item?"Simpan":"Buat"}</button></div>
  `);
  qs("#srSave").onclick = async ()=>{
    const payload = { sheep_id: qs("#srS").value, feeding_time: qs("#srT").value, status: qs("#srStatus").value };
    try{
      const opts={method:item?"PUT":"POST", body:JSON.stringify(payload)};
      if(item) await api("/api/sheep-reports/"+item.id, opts); else await api("/api/sheep-reports", opts);
      modal.classList.add("hidden"); loadSheepReports();
    }catch(e){ showErr(e); }
  };
}

/* ====== BOOT ====== */
function boot(){ syncAuthUI(); loadSummary(); }
syncAuthUI(); if(ADMIN_TOKEN) boot();
</script>
</body>
</html>
