<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Damayanti</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f9ff; --card:#fff; --ink:#0f172a; --muted:#667085; --line:#e5e7eb;
      --primary:#1e66ff; --primary-ink:#fff; --danger:#ef4444;
      --pill:#ecf2ff; --pill-ink:#1e66ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .h1{font-weight:700;font-size:20px}
    .tag{font-size:12px;color:#0a0;opacity:.75}
    .tabs{display:flex;gap:10px;margin:12px 0 20px}
    .pill{padding:10px 14px;border-radius:999px;background:#fff;border:1px solid #cfe0ff;color:#235;cursor:pointer}
    .pill.active{background:var(--pill);color:var(--pill-ink);border-color:transparent}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(15,23,42,.04)}
    .row{display:flex;align-items:center;gap:12px}
    .space{flex:1}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink)}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--line);padding:10px 12px;text-align:left;font-size:14px}
    th{background:#fafbff;color:#334}
    .muted{font-size:12px;color:var(--muted)}
    .btn{background:var(--primary);color:var(--primary-ink);border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.ghost{background:#eef3ff;color:#234}
    .btn.danger{background:var(--danger)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .right{float:right}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .modal .box{background:#fff;border-radius:16px;min-width:320px;max-width:640px;width:100%;padding:16px}
    .title{font-weight:600;margin-bottom:8px}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    /* mini badge */
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#334}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="h1">Admin Dashboard — Damayanti</div>
      <div>
        <span class="muted" id="loginState">Logged out</span>
        <button class="btn ghost" id="btnLogin">Login</button>
        <button class="btn danger" id="btnLogout" style="display:none">Keluar</button>
      </div>
    </div>

    <div class="tabs">
      <button class="pill"   data-tab="summary">Ringkasan</button>
      <button class="pill"   data-tab="containers">Containers</button>
      <button class="pill"   data-tab="students">Students</button>
      <button class="pill"   data-tab="sensor">Sensor Data</button>
      <button class="pill"   data-tab="reports">Reports</button>
      <button class="pill"   data-tab="sheeps">Sheeps</button>
    </div>

    <div id="view"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="row">
        <div class="title" id="modalTitle">Modal</div>
        <div class="space"></div>
        <button class="btn ghost" id="modalClose">Tutup</button>
      </div>
      <div id="modalBody" class="mt12"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIG & HELPERS
========================= */
const API_BASE = "https://damayanti-api.vercel.app";
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function token() { return localStorage.getItem("token") || ""; }
function setToken(t){ localStorage.setItem("token", t||""); paintAuth(); }

function paintAuth(){
  const t = token();
  $("#loginState").textContent = t ? "Logged in" : "Logged out";
  $("#btnLogin").style.display  = t ? "none" : "";
  $("#btnLogout").style.display = t ? "" : "none";
}

// helper fetch dengan error detail
async function api(url, opts = {}) {
  const headers = {
    "Content-Type": "application/json",
    ...(token() ? { "Authorization": `Bearer ${token()}` } : {}),
    ...(opts.headers || {})
  };
  const res = await fetch(`${API_BASE}${url}`, { ...opts, headers });

  if (!res.ok) {
    let detail = `${res.status} : ${res.statusText}`;
    try {
      const data = await res.json();
      // tampilin pesan detail dari backend kalau ada
      const msg = data.message || data.error || JSON.stringify(data);
      detail = `${res.status} : ${msg}`;
    } catch {
      const txt = await res.text().catch(()=>"");
      if (txt) detail = `${res.status} : ${txt}`;
    }
    throw new Error(detail);
  }
  if (res.status === 204) return null;
  return res.json();
}
function showErr(e){ alert(e.message || e); }

/* =========================
   Router tab sederhana
========================= */
let tab = "students"; // default kamu sering uji students
let state = {
  containers: [],
  students:   [],
  sheeps:     [],
  sensors:    [],
  reports:    []
};

function setTab(name){
  tab = name;
  $$(".pill").forEach(p=>p.classList.toggle("active", p.dataset.tab===name));
  render();
}

$$(".pill").forEach(p => p.onclick = () => setTab(p.dataset.tab));

/* =========================
   Views
========================= */
async function render(){
  const v = $("#view");
  v.innerHTML = "";

  if (tab === "summary") return renderSummary(v);
  if (tab === "containers") return renderContainers(v);
  if (tab === "students") return renderStudents(v);
  if (tab === "sensor") return renderSensors(v);
  if (tab === "reports") return renderReports(v);
  if (tab === "sheeps") return renderSheeps(v);
}

/* =========================
   SUMMARY
========================= */
async function renderSummary(host){
  host.innerHTML = `
    <div class="card">
      <div class="row">
        <div class="title">Ringkasan</div>
        <span class="badge">read only</span>
      </div>
      <div class="mt12 muted">Gunakan tab lain untuk CRUD.</div>
    </div>
  `;
}

/* =========================
   CONTAINERS (Admin only)
========================= */
async function loadContainers(){
  try { state.containers = await api("/api/containers"); }
  catch(e){ state.containers = []; showErr(e); }
}
function renderContainerTable(list){
  return `
    <table class="mt12">
      <thead><tr>
        <th>ID</th><th>Nama/Kode</th><th>Lokasi</th><th>Dibuat</th><th>Aksi</th>
      </tr></thead>
      <tbody>
        ${list.length ? list.map(c=>`
          <tr>
            <td>${c.id}</td>
            <td>${c.name || c.code || "-"}</td>
            <td>${c.location || "-"}</td>
            <td>${c.created_at ? new Date(c.created_at).toLocaleString() : "-"}</td>
            <td class="toolbar">
              <button class="btn ghost" data-edc="${c.id}">Ubah</button>
              <button class="btn danger" data-delc="${c.id}">Hapus</button>
            </td>
          </tr>
        `).join("") : `<tr><td colspan="5" class="muted">Tidak ada data.</td></tr>`}
      </tbody>
    </table>
  `;
}
async function renderContainers(host){
  await loadContainers();
  host.innerHTML = `
    <div class="card">
      <div class="row">
        <div class="title">Containers</div>
        <span class="badge">Admin only tambah/ubah/hapus</span>
        <div class="space"></div>
        <input id="cariC" placeholder="Cari nama/kode..." style="max-width:320px">
        <button class="btn" id="btnAddC">Tambah</button>
      </div>
      <div id="tblC">${renderContainerTable(state.containers)}</div>
    </div>
  `;
  $("#btnAddC").onclick = ()=> showContainerForm();
  $("#tblC").onclick = e=>{
    const del = e.target.closest("[data-delc]");
    const ed  = e.target.closest("[data-edc]");
    if (del) deleteContainer(del.dataset.delc);
    if (ed)  showContainerForm(state.containers.find(x=>x.id===ed.dataset.edc));
  };
}
function showContainerForm(item){
  openModal(item ? "Ubah Container":"Tambah Container", `
    <div class="mt8">
      <label class="muted">Nama/Kode</label>
      <input id="cName" value="${item?.name || item?.code || ""}">
    </div>
    <div class="mt8">
      <label class="muted">Lokasi</label>
      <input id="cLoc" value="${item?.location || ""}">
    </div>
    <div class="toolbar mt16"><button id="saveC" class="btn">${item?"Simpan":"Buat"}</button></div>
  `);
  $("#saveC").onclick = async ()=>{
    const payload = { name: $("#cName").value.trim(), location: $("#cLoc").value.trim() };
    try{
      if(item) await api(`/api/containers/${item.id}`, {method:"PUT", body:JSON.stringify(payload)});
      else     await api(`/api/containers`,          {method:"POST",body:JSON.stringify(payload)});
      closeModal(); renderContainers($("#view"));
    }catch(e){ showErr(e); }
  };
}
async function deleteContainer(id){
  if(!confirm("Hapus container ini?")) return;
  try{ await api(`/api/containers/${id}`, {method:"DELETE"}); renderContainers($("#view")); }
  catch(e){ showErr(e); }
}

/* =========================
   STUDENTS (Admin only)
========================= */
async function loadStudents(){
  try { state.students = await api("/api/students"); }
  catch(e){ state.students = []; showErr(e); }
}
function renderStudentTable(list){
  return `
    <table class="mt12">
      <thead><tr><th>ID</th><th>Nama</th><th>Dibuat</th><th>Aksi</th></tr></thead>
      <tbody>
        ${list.length ? list.map(s=>`
          <tr>
            <td>${s.id}</td>
            <td>${s.name || s.full_name || "-"}</td>
            <td>${s.created_at ? new Date(s.created_at).toLocaleString() : "-"}</td>
            <td class="toolbar">
              <button class="btn ghost" data-eds="${s.id}">Ubah</button>
              <button class="btn danger" data-dels="${s.id}">Hapus</button>
            </td>
          </tr>
        `).join("") : `<tr><td colspan="4" class="muted">Tidak ada data.</td></tr>`}
      </tbody>
    </table>
  `;
}
async function renderStudents(host){
  await loadStudents();
  host.innerHTML = `
    <div class="card">
      <div class="row">
        <div class="title">Students</div>
        <span class="badge">Admin only tambah/ubah/hapus</span>
        <div class="space"></div>
        <input id="searchS" placeholder="Cari nama..." style="max-width:320px">
        <button class="btn" id="btnAddS">Tambah</button>
      </div>
      <div id="tblS">${renderStudentTable(state.students)}</div>
    </div>
  `;
  $("#btnAddS").onclick = ()=> showStudentForm();
  $("#tblS").onclick = e=>{
    const del = e.target.closest("[data-dels]");
    const ed  = e.target.closest("[data-eds]");
    if (del) deleteStudent(del.dataset.dels);
    if (ed)  showStudentForm(state.students.find(x=>x.id===ed.dataset.eds));
  };
}
function showStudentForm(item){
  openModal(item ? "Ubah Student" : "Tambah Student", `
    <div>
      <label class="muted">Nama Lengkap</label>
      <input id="sName" minlength="3" value="${item?.name || item?.full_name || ""}" placeholder="Minimal 3 huruf">
    </div>
    <div class="toolbar mt16">
      <button id="saveS" class="btn">${item ? "Simpan" : "Buat"}</button>
    </div>
    <div class="note">Endpoint: ${item ? "PUT /api/students/{id}" : "POST /api/students"} — field dikirim: <b>full_name</b> & <b>name</b> (auto fallback)</div>
  `);

  $("#saveS").onclick = async ()=>{
    const nm = $("#sName").value.trim();
    if (nm.length < 3) { alert("Nama minimal 3 karakter."); return; }

    try{
      if (item) {
        // Saat update kirim dua-duanya juga
        await api(`/api/students/${item.id}`, { method:"PUT", body: JSON.stringify({ full_name: nm, name: nm }) });
      } else {
        // SMART CREATE: coba 3 skema berbeda agar lolos validasi backend apa pun
        await tryCreateStudentSmart(nm);
      }
      closeModal(); renderStudents($("#view"));
    }catch(e){ showErr(e); }
  };
}
async function tryCreateStudentSmart(nm){
  // 1) Dua-duanya
  try { 
    return await api("/api/students", { method:"POST", body: JSON.stringify({ full_name: nm, name: nm }) });
  } catch(e1){
    // 2) Hanya full_name
    try {
      return await api("/api/students", { method:"POST", body: JSON.stringify({ full_name: nm }) });
    } catch(e2){
      // 3) Hanya name
      try {
        return await api("/api/students", { method:"POST", body: JSON.stringify({ name: nm }) });
      } catch(e3){
        // munculkan error paling detail (urutan terakhir biasanya paling informatif)
        throw e3;
      }
    }
  }
}
async function deleteStudent(id){
  if(!confirm("Hapus student ini?")) return;
  try{ await api(`/api/students/${id}`, {method:"DELETE"}); renderStudents($("#view")); }
  catch(e){ showErr(e); }
}

/* =========================
   SHEEPS (tanpa umur)
========================= */
async function loadSheeps(){
  try { state.sheeps = await api("/api/sheeps"); }
  catch(e){ state.sheeps = []; showErr(e); }
}
function renderSheepTable(list){
  return `
    <table class="mt12">
      <thead><tr><th>ID</th><th>Nama</th><th>Dibuat</th><th>Aksi</th></tr></thead>
      <tbody>
        ${list.length ? list.map(sh=>`
          <tr>
            <td>${sh.id}</td>
            <td>${sh.name || "-"}</td>
            <td>${sh.created_at ? new Date(sh.created_at).toLocaleString() : "-"}</td>
            <td class="toolbar">
              <button class="btn ghost" data-edsheep="${sh.id}">Ubah</button>
              <button class="btn danger" data-delsheep="${sh.id}">Hapus</button>
            </td>
          </tr>
        `).join("") : `<tr><td colspan="4" class="muted">Tidak ada data.</td></tr>`}
      </tbody>
    </table>
  `;
}
async function renderSheeps(host){
  await loadSheeps();
  host.innerHTML = `
    <div class="card">
      <div class="row">
        <div class="title">Sheeps</div>
        <span class="badge">CRUD nama saja</span>
        <div class="space"></div>
        <input id="searchSh" placeholder="Cari nama..." style="max-width:320px">
        <button class="btn" id="btnAddSh">Tambah</button>
      </div>
      <div id="tblSh">${renderSheepTable(state.sheeps)}</div>
    </div>
  `;
  $("#btnAddSh").onclick = ()=> showSheepForm();
  $("#tblSh").onclick = e=>{
    const del = e.target.closest("[data-delsheep]");
    const ed  = e.target.closest("[data-edsheep]");
    if (del) deleteSheep(del.dataset.delsheep);
    if (ed)  showSheepForm(state.sheeps.find(x=>x.id===ed.dataset.edsheep));
  };
}
function showSheepForm(item){
  openModal(item ? "Ubah Sheep" : "Tambah Sheep", `
    <div>
      <label class="muted">Nama</label>
      <input id="shName" minlength="2" value="${item?.name || ""}">
    </div>
    <div class="toolbar mt16">
      <button id="saveSh" class="btn">${item ? "Simpan" : "Buat"}</button>
    </div>
  `);
  $("#saveSh").onclick = async ()=>{
    const nm = $("#shName").value.trim();
    if (!nm) { alert("Nama tidak boleh kosong"); return; }
    try{
      if(item) await api(`/api/sheeps/${item.id}`, {method:"PUT",  body:JSON.stringify({name:nm})});
      else     await api(`/api/sheeps`,          {method:"POST", body:JSON.stringify({name:nm})});
      closeModal(); renderSheeps($("#view"));
    }catch(e){ showErr(e); }
  };
}
async function deleteSheep(id){
  if(!confirm("Hapus sheep ini?")) return;
  try{ await api(`/api/sheeps/${id}`, {method:"DELETE"}); renderSheeps($("#view")); }
  catch(e){ showErr(e); }
}

/* =========================
   SENSOR DATA (read/CRUD)
========================= */
async function loadSensors(){
  try { state.sensors = await api("/api/sensor-data"); }
  catch(e){ state.sensors = []; showErr(e); }
}
function renderSensorTable(list){
  return `
    <table class="mt12">
      <thead>
        <tr><th>ID</th><th>Container</th><th>Recorded</th><th>T</th><th>H</th><th>G</th><th>pH</th><th>Status</th><th>Aksi</th></tr>
      </thead>
      <tbody>
        ${list.length ? list.map(s=>`
          <tr>
            <td>${s.id}</td>
            <td>${s.container_id || "-"}</td>
            <td>${s.recorded_at ? new Date(s.recorded_at).toLocaleString() : "-"}</td>
            <td>${s.temperature ?? "-"}</td>
            <td>${s.humidity ?? "-"}</td>
            <td>${s.gas ?? "-"}</td>
            <td>${s.ph ?? "-"}</td>
            <td>${s.status ?? "-"}</td>
            <td class="toolbar">
              <button class="btn danger" data-delsen="${s.id}">Hapus</button>
            </td>
          </tr>
        `).join("") : `<tr><td colspan="9" class="muted">Tidak ada data.</td></tr>`}
      </tbody>
    </table>
  `;
}
async function renderSensors(host){
  await loadSensors();
  host.innerHTML = `
    <div class="card">
      <div class="row">
        <div class="title">Sensor Data</div>
        <div class="space"></div>
        <button class="btn" id="btnAddSen">Tambah</button>
      </div>
      <div id="tblSen">${renderSensorTable(state.sensors)}</div>
    </div>
  `;
  $("#btnAddSen").onclick = ()=> showSensorForm();
  $("#tblSen").onclick = async e=>{
    const del = e.target.closest("[data-delsen]");
    if (del && confirm("Hapus data ini?")) {
      try{ await api(`/api/sensor-data/${del.dataset.delsen}`, {method:"DELETE"}); renderSensors($("#view")); }
      catch(e){ showErr(e); }
    }
  };
}
function showSensorForm(){
  openModal("Tambah Sensor Data", `
    <div class="row">
      <div style="flex:1">
        <label class="muted">Container ID</label>
        <input id="sdC" placeholder="container_id">
      </div>
      <div style="width:160px">
        <label class="muted">Tanggal/Waktu</label>
        <input id="sdT" type="datetime-local">
      </div>
    </div>
    <div class="row mt12">
      <input id="sdTemp" placeholder="Temperature (°C)">
      <input id="sdHum"  placeholder="Humidity (%)">
      <input id="sdGas"  placeholder="Gas (ppm)">
      <input id="sdPh"   placeholder="pH">
    </div>
    <div class="mt12">
      <label class="muted">Status</label>
      <input id="sdStatus" placeholder="Merah/Kuning/Hijau">
    </div>
    <div class="toolbar mt16"><button class="btn" id="saveSD">Simpan</button></div>
  `);
  $("#saveSD").onclick = async ()=>{
    const payload = {
      container_id: $("#sdC").value.trim(),
      recorded_at:  $("#sdT").value ? new Date($("#sdT").value).toISOString() : new Date().toISOString(),
      temperature:  parseFloat($("#sdTemp").value) || null,
      humidity:     parseFloat($("#sdHum").value)  || null,
      gas:          parseFloat($("#sdGas").value)  || null,
      ph:           parseFloat($("#sdPh").value)   || null,
      status:       $("#sdStatus").value.trim() || null
    };
    try{
      await api("/api/sensor-data", {method:"POST", body:JSON.stringify(payload)});
      closeModal(); renderSensors($("#view"));
    }catch(e){ showErr(e); }
  };
}

/* =========================
   REPORTS (read/CRUD)
========================= */
async function loadReports(){
  try { state.reports = await api("/api/reports"); }
  catch(e){ state.reports = []; showErr(e); }
}
function renderReportTable(list){
  return `
    <table class="mt12">
      <thead><tr><th>ID</th><th>Container</th><th>Tanggal</th><th>Catatan</th><th>Aksi</th></tr></thead>
      <tbody>
        ${list.length ? list.map(r=>`
          <tr>
            <td>${r.id}</td>
            <td>${r.container_id || "-"}</td>
            <td>${r.report_date ? new Date(r.report_date).toLocaleString() : "-"}</td>
            <td>${r.notes || "-"}</td>
            <td class="toolbar">
              <button class="btn danger" data-delrep="${r.id}">Hapus</button>
            </td>
          </tr>
        `).join("") : `<tr><td colspan="5" class="muted">Tidak ada data.</td></tr>`}
      </tbody>
    </table>
  `;
}
async function renderReports(host){
  await loadReports();
  host.innerHTML = `
    <div class="card">
      <div class="row">
        <div class="title">Reports</div>
        <div class="space"></div>
        <button class="btn" id="btnAddRep">Tambah</button>
      </div>
      <div id="tblRep">${renderReportTable(state.reports)}</div>
    </div>
  `;
  $("#btnAddRep").onclick = ()=> showReportForm();
  $("#tblRep").onclick = async e=>{
    const del = e.target.closest("[data-delrep]");
    if (del && confirm("Hapus report ini?")) {
      try{ await api(`/api/reports/${del.dataset.delrep}`, {method:"DELETE"}); renderReports($("#view")); }
      catch(e){ showErr(e); }
    }
  };
}
function showReportForm(){
  openModal("Tambah Report", `
    <div class="row">
      <input id="rpC" placeholder="Container ID">
      <input id="rpT" type="datetime-local">
    </div>
    <div class="mt12">
      <textarea id="rpN" rows="3" placeholder="Catatan"></textarea>
    </div>
    <div class="toolbar mt16"><button class="btn" id="saveRep">Simpan</button></div>
  `);
  $("#saveRep").onclick = async ()=>{
    const payload = {
      container_id: $("#rpC").value.trim(),
      report_date:  $("#rpT").value ? new Date($("#rpT").value).toISOString() : new Date().toISOString(),
      notes:        $("#rpN").value.trim()
    };
    try{
      await api("/api/reports", {method:"POST", body:JSON.stringify(payload)});
      closeModal(); renderReports($("#view"));
    }catch(e){ showErr(e); }
  };
}

/* =========================
   Modal helpers
========================= */
const modal = $("#modal");
$("#modalClose").onclick = closeModal;
function openModal(title, bodyHtml){
  $("#modalTitle").innerHTML = title;
  $("#modalBody").innerHTML  = bodyHtml;
  modal.classList.add("open");
}
function closeModal(){ modal.classList.remove("open"); }

/* =========================
   Auth (login sederhana)
========================= */
$("#btnLogin").onclick = ()=>{
  openModal("Login Admin", `
    <div class="row">
      <input id="lgEmail" placeholder="email">
      <input id="lgPass" type="password" placeholder="password">
    </div>
    <div class="toolbar mt16"><button id="doLogin" class="btn">Login</button></div>
    <div class="note">Endpoint: <b>POST /api/auth/login</b> → simpan token ke localStorage</div>
  `);
  $("#doLogin").onclick = async ()=>{
    try{
      const data = await api("/api/auth/login", {
        method:"POST",
        body:JSON.stringify({ email: $("#lgEmail").value.trim(), password: $("#lgPass").value })
      });
      setToken(data?.token || data?.access_token || "");
      closeModal(); alert("Login sukses");
    }catch(e){ showErr(e); }
  };
};
$("#btnLogout").onclick = ()=>{ setToken(""); alert("Logged out"); };

/* init */
paintAuth();
setTab(tab);
</script>
</body>
</html>
